# 依赖注入优化方案

## 当前问题

```java
// 每个Activity都要手动创建依赖
AppDatabase database = AppDatabase.getInstance(this);
VocabularyRecordRepository repository = new VocabularyRecordRepository(database.vocabularyDao());
UserSettingsRepository settingsRepository = new UserSettingsRepository(this);
```

**痛点：**
- 代码重复
- 耦合度高
- 难以测试（无法轻松替换为Mock对象）
- 单例管理复杂

## 解决方案：Dagger Hilt

### 1. 添加依赖

```kotlin
// project build.gradle.kts
plugins {
    id("com.google.dagger.hilt.android") version "2.50" apply false
}

// app/build.gradle.kts
plugins {
    id("com.google.dagger.hilt.android")
}

dependencies {
    implementation("com.google.dagger:hilt-android:2.50")
    annotationProcessor("com.google.dagger:hilt-compiler:2.50")
    
    // 测试支持
    testImplementation("com.google.dagger:hilt-android-testing:2.50")
    androidTestImplementation("com.google.dagger:hilt-android-testing:2.50")
}
```

### 2. 创建 Application 类

```java
@HiltAndroidApp
public class EnglishLearningApp extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        // 初始化代码
    }
}
```

```xml
<!-- AndroidManifest.xml -->
<application
    android:name=".EnglishLearningApp"
    ...>
</application>
```

### 3. 提供依赖 - 创建 Module

```java
@Module
@InstallIn(SingletonComponent.class)
public class DatabaseModule {
    
    @Provides
    @Singleton
    public AppDatabase provideDatabase(@ApplicationContext Context context) {
        return Room.databaseBuilder(
            context,
            AppDatabase.class,
            "english_learning_db"
        )
        .fallbackToDestructiveMigration()
        // 移除 allowMainThreadQueries
        .build();
    }
    
    @Provides
    public VocabularyDao provideVocabularyDao(AppDatabase database) {
        return database.vocabularyDao();
    }
    
    @Provides
    public ExamDao provideExamDao(AppDatabase database) {
        return database.examDao();
    }
    
    @Provides
    public StudyRecordDao provideStudyRecordDao(AppDatabase database) {
        return database.studyRecordDao();
    }
    
    @Provides
    public QuestionDao provideQuestionDao(AppDatabase database) {
        return database.questionDao();
    }
    
    @Provides
    public StudyPlanDao provideStudyPlanDao(AppDatabase database) {
        return database.studyPlanDao();
    }
    
    @Provides
    public UserSettingsDao provideUserSettingsDao(AppDatabase database) {
        return database.userSettingsDao();
    }
}
```

```java
@Module
@InstallIn(SingletonComponent.class)
public class RepositoryModule {
    
    @Provides
    @Singleton
    public VocabularyRecordRepository provideVocabularyRepository(
            VocabularyDao vocabularyDao) {
        return new VocabularyRecordRepository(vocabularyDao);
    }
    
    @Provides
    @Singleton
    public ExamRecordRepository provideExamRepository(ExamDao examDao) {
        return new ExamRecordRepository(examDao);
    }
    
    @Provides
    @Singleton
    public StudyRecordRepository provideStudyRecordRepository(
            StudyRecordDao studyRecordDao) {
        return new StudyRecordRepository(studyRecordDao);
    }
    
    @Provides
    @Singleton
    public UserSettingsRepository provideUserSettingsRepository(
            @ApplicationContext Context context) {
        return new UserSettingsRepository(context);
    }
}
```

```java
@Module
@InstallIn(SingletonComponent.class)
public class ServiceModule {
    
    @Provides
    @Singleton
    public DataLinkageService provideDataLinkageService(
            @ApplicationContext Context context) {
        return new DataLinkageService(context);
    }
    
    @Provides
    @Singleton
    public DataImportExportService provideDataImportExportService(
            @ApplicationContext Context context) {
        return new DataImportExportService(context);
    }
}
```

### 4. 在 Activity 中注入依赖

```java
@AndroidEntryPoint
public class VocabularyActivity extends AppCompatActivity {
    
    @Inject
    VocabularyRecordRepository vocabularyRepository;
    
    @Inject
    StudyRecordRepository studyRecordRepository;
    
    private VocabularyViewModel viewModel;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_vocabulary);
        
        // 依赖自动注入，无需手动创建
        // vocabularyRepository 和 studyRecordRepository 已经可用
        
        setupViewModel();
        initViews();
    }
    
    private void setupViewModel() {
        VocabularyViewModelFactory factory = 
            new VocabularyViewModelFactory(vocabularyRepository);
        viewModel = new ViewModelProvider(this, factory)
            .get(VocabularyViewModel.class);
    }
}
```

### 5. ViewModel 注入（更优雅）

```java
// 使用 @HiltViewModel 注解
@HiltViewModel
public class VocabularyViewModel extends ViewModel {
    private final VocabularyRecordRepository vocabularyRepository;
    private final StudyRecordRepository studyRecordRepository;
    
    @Inject
    public VocabularyViewModel(
            VocabularyRecordRepository vocabularyRepository,
            StudyRecordRepository studyRecordRepository) {
        this.vocabularyRepository = vocabularyRepository;
        this.studyRecordRepository = studyRecordRepository;
    }
    
    // ViewModel 逻辑
}
```

```java
// Activity 中使用
@AndroidEntryPoint
public class VocabularyActivity extends AppCompatActivity {
    
    private VocabularyViewModel viewModel;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_vocabulary);
        
        // 无需 Factory，Hilt 自动注入
        viewModel = new ViewModelProvider(this).get(VocabularyViewModel.class);
        
        observeViewModel();
    }
}
```

### 6. 测试支持

```java
@HiltAndroidTest
@UninstallModules(DatabaseModule.class)
public class VocabularyActivityTest {
    
    @Module
    @InstallIn(SingletonComponent.class)
    public static class TestDatabaseModule {
        @Provides
        @Singleton
        public AppDatabase provideDatabase(@ApplicationContext Context context) {
            // 使用内存数据库进行测试
            return Room.inMemoryDatabaseBuilder(context, AppDatabase.class)
                .allowMainThreadQueries()
                .build();
        }
    }
    
    @Rule
    public HiltAndroidRule hiltRule = new HiltAndroidRule(this);
    
    @Inject
    VocabularyRecordRepository repository;
    
    @Before
    public void setup() {
        hiltRule.inject();
    }
    
    @Test
    public void testVocabularyRepository() {
        // repository 已经注入，可以直接使用
        assertNotNull(repository);
    }
}
```

## 轻量级替代方案：Koin（Kotlin）

如果使用Kotlin，Koin是更简单的选择：

```kotlin
// 添加依赖
dependencies {
    implementation("io.insert-koin:koin-android:3.5.3")
}

// 定义模块
val databaseModule = module {
    single {
        Room.databaseBuilder(
            androidContext(),
            AppDatabase::class.java,
            "english_learning_db"
        ).build()
    }
    single { get<AppDatabase>().vocabularyDao() }
    single { get<AppDatabase>().examDao() }
}

val repositoryModule = module {
    single { VocabularyRecordRepository(get()) }
    single { ExamRecordRepository(get()) }
}

// 在 Application 中初始化
class EnglishLearningApp : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
            androidContext(this@EnglishLearningApp)
            modules(databaseModule, repositoryModule)
        }
    }
}

// 在 Activity 中使用
class VocabularyActivity : AppCompatActivity() {
    private val repository: VocabularyRecordRepository by inject()
    private val viewModel: VocabularyViewModel by viewModel()
}
```

## 对比分析

| 特性 | 手动依赖 | Dagger Hilt | Koin |
|------|---------|-------------|------|
| 学习曲线 | 低 | 高 | 中 |
| 编译时检查 | ❌ | ✅ | ❌ |
| 性能 | 中 | 优秀 | 良好 |
| 代码生成 | ❌ | ✅ | ❌ |
| 测试支持 | 差 | 优秀 | 良好 |
| 配置复杂度 | 低 | 高 | 低 |
| 适用语言 | Java/Kotlin | Java/Kotlin | Kotlin |

## 推荐方案

- **纯Java项目**：使用 **Dagger Hilt**
- **Kotlin项目**：使用 **Koin**（简单）或 **Dagger Hilt**（大型项目）
- **小型项目**：可以保持手动依赖，但要封装工厂类

## 预期收益

- ✅ 代码量减少 20-30%
- ✅ 耦合度降低
- ✅ 测试效率提升 50%+
- ✅ 依赖管理统一
- ✅ 支持多环境配置（开发/测试/生产）


